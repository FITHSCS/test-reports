<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: #fefefe;
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        position: relative;
    }
    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close-button:hover {
        color: black;
    }
</style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8 md:p-10">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-6 text-center">
            Test Report Dashboard
        </h1>

        <!-- Overall Summary Section -->
        <section class="mb-8 p-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4">Latest Run Summary</h2>
            <div id="overall-summary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Summary data will be injected here -->
            </div>
        </section>

        <!-- Pass/Fail Matrix Section -->
        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Test Results (Latest Run)</h2>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Test Suite</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Total</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Passed</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Failed</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Skipped</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Coverage</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Duration</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="pass-fail-matrix" class="divide-y divide-gray-200">
                        <!-- Test suite data will be injected here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Historical Runs Section -->
        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Historical Test Runs</h2>
            <div class="bg-gray-100 p-4 rounded-lg mb-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label for="filter-from-date" class="block text-sm font-medium text-gray-700">From Date:</label>
                        <input type="date" id="filter-from-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="filter-to-date" class="block text-sm font-medium text-gray-700">To Date:</label>
                        <input type="date" id="filter-to-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="filter-branch" class="block text-sm font-medium text-gray-700">Branch:</label>
                        <select id="filter-branch" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            <option value="">All Branches</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 space-x-4">
                    <button id="apply-filters-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Apply Filters
                    </button>
                    <button id="clear-filters-btn" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Clear Filters
                    </button>
                </div>
            </div>
            <div id="historical-runs" class="space-y-4">
                <!-- Historical run data will be injected here -->
            </div>
        </section>

        <!-- Summary Log Section -->
        <section>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Summary Report</h2>
            <div class="bg-blue-50 p-6 rounded-lg shadow-md">
                <button id="generate-summary-btn" class="px-6 py-3 bg-teal-600 text-white rounded-md hover:bg-teal-700">
                    Generate Summary Report
                </button>
                <div id="sprint-summary-output" class="mt-6 p-4 bg-white border rounded-lg hidden">
                    <h3 class="text-xl font-semibold mb-3">Summary:</h3>
                    <div id="sprint-passed-summary" class="mb-2"></div>
                    <div id="sprint-failed-summary" class="mb-2"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal for Test Suite Details -->
    <div id="suite-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 class="text-2xl font-bold mb-4">Test Suite Details</h3>
            <div id="modal-suite-name" class="text-xl font-semibold mb-2"></div>
            <div id="modal-suite-status" class="mb-4"></div>
            <p>Total Tests: <span id="modal-suite-total" class="font-medium"></span></p>
            <p>Passed: <span id="modal-suite-passed" class="font-medium text-green-700"></span></p>
            <p>Failed: <span id="modal-suite-failed" class="font-medium text-red-700"></span></p>
            <p>Skipped: <span id="modal-suite-skipped" class="font-medium text-yellow-700"></span></p>
            <p>Coverage: <span id="modal-suite-coverage" class="font-medium"></span>%</p>
            <p>Duration: <span id="modal-suite-duration" class="font-medium"></span></p>
        </div>
    </div>

    <script>
        // Data injection placeholder
        const injectedHistoricalRunsData = [];
        
        let allHistoricalRuns = [];
        let currentTestSummary = {};

        function renderOverallSummary(summaryData) {
            const div = document.getElementById('overall-summary');
            if (!div) return;
            const { total, passed, failed, skipped, coverage } = summaryData.summary;
            const { branch, commit, timestamp, duration, status } = summaryData;
            
            div.innerHTML = `
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <p class="text-sm opacity-80">Branch / Commit</p>
                    <p class="text-xl font-bold">${branch} / ${commit.substring(0, 7)}</p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <p class="text-sm opacity-80">Status</p>
                    <p class="text-xl font-bold ${status === 'passed' ? 'text-green-300' : 'text-red-300'}">${status.toUpperCase()}</p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <p class="text-sm opacity-80">Total Tests</p>
                    <p class="text-xl font-bold">${total}</p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <p class="text-sm opacity-80">Passed</p>
                    <p class="text-xl font-bold text-green-300">${passed}</p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <p class="text-sm opacity-80">Failed</p>
                    <p class="text-xl font-bold text-red-300">${failed}</p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <p class="text-sm opacity-80">Coverage</p>
                    <p class="text-xl font-bold">${coverage}%</p>
                </div>
            `;
        }

        function renderPassFailMatrix(suitesData, branch, commit) {
            const tbody = document.getElementById('pass-fail-matrix');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            suitesData.forEach(suite => {
                const statusClass = suite.status === 'passed' ? 'text-green-600' : 'text-red-600';
                const row = document.createElement('tr');
                row.className = 'cursor-pointer hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 font-medium">${suite.name}</td>
                    <td class="py-3 px-4">${suite.tests}</td>
                    <td class="py-3 px-4 text-green-700">${suite.passed}</td>
                    <td class="py-3 px-4 text-red-700">${suite.failed}</td>
                    <td class="py-3 px-4 text-yellow-700">${suite.skipped}</td>
                    <td class="py-3 px-4">${suite.coverage}%</td>
                    <td class="py-3 px-4">${suite.duration}</td>
                    <td class="py-3 px-4 ${statusClass} font-medium">${suite.status.toUpperCase()}</td>
                `;
                row.onclick = () => showSuiteDetails(suite, branch, commit);
                tbody.appendChild(row);
            });
        }

        function showSuiteDetails(suite, branch, commit) {
            const modal = document.getElementById('suite-details-modal');
            document.getElementById('modal-suite-name').textContent = suite.name;
            document.getElementById('modal-suite-total').textContent = suite.tests;
            document.getElementById('modal-suite-passed').textContent = suite.passed;
            document.getElementById('modal-suite-failed').textContent = suite.failed;
            document.getElementById('modal-suite-skipped').textContent = suite.skipped;
            document.getElementById('modal-suite-coverage').textContent = suite.coverage;
            document.getElementById('modal-suite-duration').textContent = suite.duration;
            
            const statusSpan = document.createElement('span');
            statusSpan.className = `inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${suite.status === 'passed' ? 'bg-green-500' : 'bg-red-500'} text-white`;
            statusSpan.textContent = suite.status.toUpperCase();
            const statusContainer = document.getElementById('modal-suite-status');
            statusContainer.innerHTML = '';
            statusContainer.appendChild(statusSpan);
            
            modal.style.display = 'flex';
        }

        function renderHistoricalRuns(runs) {
            const div = document.getElementById('historical-runs');
            if (!div) return;
            div.innerHTML = '';
            
            if (runs.length === 0) {
                div.innerHTML = '<p class="text-gray-600 text-center py-8">No historical test runs found.</p>';
                return;
            }
            
            runs.forEach(run => {
                const statusColor = run.status === 'passed' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const icon = run.status === 'passed' ? '✅' : '❌';
                const card = `
                    <div class="flex items-center bg-gray-50 p-4 rounded-lg shadow-sm">
                        <div class="flex-shrink-0 mr-4 text-2xl">${icon}</div>
                        <div class="flex-grow">
                            <p class="text-lg font-semibold">
                                <span class="text-blue-600">${run.branch}</span> / 
                                <span class="text-gray-700">${run.commit.substring(0, 7)}</span>
                            </p>
                            <p class="text-sm text-gray-600">Ran on: ${new Date(run.timestamp).toLocaleString()}</p>
                            <p class="text-sm text-gray-600">
                                Passed: <span class="font-medium text-green-700">${run.summary.passed}</span> / 
                                Total: <span class="font-medium">${run.summary.total}</span> 
                                (Coverage: ${run.summary.coverage}%)
                            </p>
                        </div>
                        <div class="ml-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                                ${run.status.toUpperCase()}
                            </span>
                        </div>
                    </div>
                `;
                div.innerHTML += card;
            });
        }

        function populateFilters(runs) {
            const branches = new Set(runs.map(run => run.branch));
            const branchSelect = document.getElementById('filter-branch');
            branchSelect.innerHTML = '<option value="">All Branches</option>';
            Array.from(branches).sort().forEach(branch => {
                branchSelect.innerHTML += `<option value="${branch}">${branch}</option>`;
            });
        }

        function getCurrentlyFilteredRuns() {
            const fromDateStr = document.getElementById('filter-from-date').value;
            const toDateStr = document.getElementById('filter-to-date').value;
            const branch = document.getElementById('filter-branch').value;
            
            let filtered = [...allHistoricalRuns];
            
            if (fromDateStr) {
                const fromDate = new Date(fromDateStr);
                filtered = filtered.filter(run => new Date(run.timestamp) >= fromDate);
            }
            if (toDateStr) {
                const toDate = new Date(toDateStr);
                filtered = filtered.filter(run => new Date(run.timestamp) <= toDate);
            }
            if (branch) {
                filtered = filtered.filter(run => run.branch === branch);
            }
            
            return filtered;
        }

        function applyFilters() {
            const filteredRuns = getCurrentlyFilteredRuns();
            renderHistoricalRuns(filteredRuns);
        }

        function clearFilters() {
            document.getElementById('filter-from-date').value = '';
            document.getElementById('filter-to-date').value = '';
            document.getElementById('filter-branch').value = '';
            renderHistoricalRuns(allHistoricalRuns);
        }

        function generateSprintReleaseOverview() {
            const runs = getCurrentlyFilteredRuns();
            const outputDiv = document.getElementById('sprint-summary-output');
            const passedDiv = document.getElementById('sprint-passed-summary');
            const failedDiv = document.getElementById('sprint-failed-summary');
            
            if (runs.length === 0) {
                outputDiv.classList.remove('hidden');
                passedDiv.innerHTML = '<p class="text-gray-700">No runs selected. Please apply filters to generate a summary.</p>';
                failedDiv.innerHTML = '';
                return;
            }
            
            const passedRuns = runs.filter(r => r.status === 'passed').length;
            const failedRuns = runs.filter(r => r.status === 'failed').length;
            
            passedDiv.innerHTML = `<p class="text-green-700 font-semibold">✅ What Passed: ${passedRuns} of ${runs.length} runs completed successfully.</p>`;
            failedDiv.innerHTML = `<p class="text-red-700 font-semibold">❌ What Failed: ${failedRuns} of ${runs.length} runs had failures.</p>`;
            
            outputDiv.classList.remove('hidden');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            allHistoricalRuns = injectedHistoricalRunsData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            currentTestSummary = allHistoricalRuns[0] || {};

            if (Object.keys(currentTestSummary).length > 0) {
                renderOverallSummary(currentTestSummary);
                renderPassFailMatrix(currentTestSummary.suites, currentTestSummary.branch, currentTestSummary.commit);
            }
            
            renderHistoricalRuns(allHistoricalRuns);
            populateFilters(allHistoricalRuns);
            
            // Setup event listeners
            document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
            document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);
            document.getElementById('generate-summary-btn').addEventListener('click', generateSprintReleaseOverview);
            
            // Modal event listeners
            const modal = document.getElementById('suite-details-modal');
            modal.querySelector('.close-button').onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target == modal) modal.style.display = 'none';
            };
        });
    </script>
</body>
</html>
